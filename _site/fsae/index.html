<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

<link rel="icon" href="/assets/images/logo.png">

<title>FSAE | James Oubre</title>

<!-- Begin Jekyll SEO tag v2.8.0 -->
<title>FSAE | James’ Portfolio</title>
<meta name="generator" content="Jekyll v3.9.0" />
<meta property="og:title" content="FSAE" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Mechanical Design / Mechatronics / PID Control" />
<meta property="og:description" content="Mechanical Design / Mechatronics / PID Control" />
<link rel="canonical" href="http://localhost:4000/fsae/" />
<meta property="og:url" content="http://localhost:4000/fsae/" />
<meta property="og:site_name" content="James’ Portfolio" />
<meta property="og:image" content="http://localhost:4000/assets/images/fsae_cropped.gif" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2021-05-23T00:00:00-05:00" />
<meta name="twitter:card" content="summary_large_image" />
<meta property="twitter:image" content="http://localhost:4000/assets/images/fsae_cropped.gif" />
<meta property="twitter:title" content="FSAE" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2021-05-23T00:00:00-05:00","datePublished":"2021-05-23T00:00:00-05:00","description":"Mechanical Design / Mechatronics / PID Control","headline":"FSAE","image":"http://localhost:4000/assets/images/fsae_cropped.gif","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/fsae/"},"publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"http://localhost:4000/assets/images/logo3.png"}},"url":"http://localhost:4000/fsae/"}</script>
<!-- End Jekyll SEO tag -->


<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
    
<link href="/assets/css/screen.css" rel="stylesheet">

<link href="/assets/css/main.css" rel="stylesheet">

<script src="/assets/js/jquery.min.js"></script>

</head>




<body class="layout-post">
	<!-- defer loading of font and font awesome -->
	<noscript id="deferred-styles">
		<link href="https://fonts.googleapis.com/css?family=Righteous%7CMerriweather:300,300i,400,400i,700,700i" rel="stylesheet">
		<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.0.13/css/all.css" integrity="sha384-DNOHZ68U8hZfKXOrtjWvjxusGo9WQnrNx2sqG0tfsghAvtVlRW3tvkXWZh58N9jp" crossorigin="anonymous">
	</noscript>


<!-- Begin Menu Navigation
================================================== -->
<nav class="navbar navbar-expand-lg navbar-light bg-white fixed-top mediumnavigation nav-down">

    <div class="container pr-0">

    <!-- Begin Logo -->
    <a class="navbar-brand" href="/">
    <img src="/assets/images/logo3.png" alt="James Oubre">
    </a>
    <!-- End Logo -->

    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarMediumish" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
    </button>

    <div class="collapse navbar-collapse" id="navbarMediumish">

        <!-- Begin Menu -->

            <ul class="navbar-nav ml-auto">

                
                <li class="nav-item">
                
                <a class="nav-link" href="/index.html">Projects</a>
                </li>
                <li class="nav-item">
                <a class="nav-link" href="/JamesOubre_Resume">Resume</a>
                </li>

                <script src="/assets/js/lunr.js"></script>


<style>
    .lunrsearchresult .title {color: #d9230f;}
    .lunrsearchresult .url {color: silver;}
    .lunrsearchresult a {display: block; color: #777;}
    .lunrsearchresult a:hover, .lunrsearchresult a:focus {text-decoration: none;}
    .lunrsearchresult a:hover .title {text-decoration: underline;}
</style>


<form class="bd-search" onSubmit="return lunr_search(document.getElementById('lunrsearch').value);">
    <input type="text" class="form-control text-small launch-modal-search" id="lunrsearch" name="q" maxlength="255" value="" placeholder="Type and enter..."/>
</form>

<div id="lunrsearchresults">
    <ul></ul>
</div>

<script src="/assets/js/lunrsearchengine.js"></script>

            </ul>

        <!-- End Menu -->

    </div>

    </div>
</nav>
<!-- End Navigation
================================================== -->

<div class="site-content">

<div class="container">

<!-- Site Title
================================================== -->
<div class="mainheading">
    <h1 class="sitetitle">James Oubre</h1>
    <p class="lead">
        Northwestern MS in Robotics Student Portfolio
    </p>
</div>

<!-- Content
================================================== -->
<div class="main-content">
    <!-- Begin Article
================================================== -->
<div class="container">
    <div class="row">

        <!-- Post -->
        

        <div class="col-md-9 flex-first flex-md-unordered">
            <div class="mainheading">

                <!-- Author Box -->
                

                <!-- Post Title -->
                <h1 class="posttitle">FSAE</h1>

            </div>

            <!-- Adsense if enabled from _config.yml (change your pub id and slot) -->
            
            <!-- End Adsense -->

            <!-- Post Content -->
            <div class="article-post">
                <!-- Toc if any -->
                
                <!-- End Toc -->
                <p>Mechanical Design / Mechatronics / PID Control</p>

<iframe width="560" height="315" src="https://www.youtube.com/embed/7S1Z_5BLMUo" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe>

<p>For my winter quarter independent study project, I set out to build my own version of a BallBot, a dynamically stable / statically unstable robot. I designed my bot from CAD to control algorithm, utilizing 3D printing, laser cutting, and C programming on an RP2040 microcontroller.</p>

<h3 id="mechanical-design">Mechanical Design</h3>

<p><img src="https://algarv.github.io/Portfolio/assets/images/ballbot_CAD.png" alt="CAD" /></p>

<p>I designed my chassis with inspiration from similar projects using Solidwork CAD to create 4 part adjustable base. Each motor housing component is attached to the main chassis separately, so the angle can be adjusted, which allowed me to test on various sizes of balls.</p>

<h3 id="building-the-structure-and-fundamental-electronics">Building the Structure and Fundamental Electronics</h3>

<p><img src="https://algarv.github.io/Portfolio/assets/images/circuit.png" alt="Circuit Diagram" /></p>

<p>After printing and assembling the chassis pieces, I mounted the 3 motors with 3 motor drivers and a RP2040 ThingPlus microcontroller and started with the basic control of one motor, working on a script to step one wheel at a time.</p>

<p><img src="https://algarv.github.io/Portfolio/assets/images/spinning.gif" alt="Spinning" /></p>

<h3 id="simultaneous-motor-control">Simultaneous Motor Control</h3>

<p>The next step was to simultaneously step three motors. This proved to be a more difficult task than anticipated, as it seemed one motor would interfere with the other’s power source. However, after switching to drivers with a higher voltage rating, I was able to step each motor sequentially.</p>

<p>Once I could send alternating stepping commands to each motor, the base could perform basic directional movement including spinning in place and uniaxial paths (forwards, backwards, sideways).</p>

<p><img src="https://algarv.github.io/Portfolio/assets/images/simulatenous_spinning.gif" alt="Simultaneous Spinning" /></p>

<p><img src="https://algarv.github.io/Portfolio/assets/images/first_steps.gif" alt="First Steps" /></p>

<h3 id="twist-commands">Twist Commands</h3>
<p><img src="https://algarv.github.io/Portfolio/assets/images/ballbot_calcs.png" alt="Calculations" />
Deriving wheel rotation rate from a twist</p>

<p>To make a truly omnidirectional base, the next step was to follow any twist, which require stepping the motors at different frequencies. I started with the most basic form of a control algorithm, a polling loop that stepped each motor after a calculated number of sleep cycles resulting in a wheel RPM calculated by the omnidirectional base matrix equation.</p>

<p><img src="https://algarv.github.io/Portfolio/assets/images/omnidirectional.gif" alt="Mobile Base" /></p>

<h3 id="position-control">Position Control</h3>

<p><img src="https://algarv.github.io/Portfolio/assets/images/control_diagram.png" alt="Control Diagram" /></p>

<p>Once the mobile base was capable of following any twist command, it was time to integrate the IMU sensor and create a closed control loop. In my first iteration, only the accelerometer data from the IMU was used to calculate a roll and pitch, which were then used as inputs to the PD controller. The PD controller outputs an x and y velocity relative to the robot’s base frame, which are then converted to wheel speeds and finally step delays using the omnidirectional base equation shown above.</p>

<h3 id="self-righting">Self-Righting</h3>

<p>The first milestone on the way to balancing was having the robot self-right itself back to a stable position on a ball. During testing, it became apparent that the motors would need to be stepped much faster in order for the robot to catch itself when the ball is not stabilized.</p>

<p><img src="https://algarv.github.io/Portfolio/assets/images/self_righting.gif" alt="Self Righting" /></p>

<h3 id="design-adjustments">Design Adjustments</h3>

<p>I redesigned the initial concept and chose to try a much larger ball in order to reduce the angle of lean and therefor the lever arm of the robot’s body over its center of mass. This, along with reducing to half steps, resulted in a smoother self-righting action but the wheel stepping was still prohibitively slow.</p>

<p><img src="https://algarv.github.io/Portfolio/assets/images/smoother.gif" alt="A Little Smoother" /></p>

<h3 id="control-adjustments-and-sensor-tuning">Control Adjustments and Sensor Tuning</h3>

<p>I tried several different approaches to the control algorithm once it became apparent that a simple polling loop would not step the motors at the required frequency. When I realized system clock-based interrupts were not support on the rp2040, I attempted 3 separate timers, with each frequency updated after every update from the IMU. While this was successful in spinning the wheels much faster, three timers could not keep up with the step frequency and the reliability of the original polling loop was lost. This was most likely due to the constant resetting of the timers and the competing operations with no set priorities. Finally, I was able to merge the control strategies and create a single timer at a fixed frequency that then counted the number of cycles since the previous step and compared the count to the calculated step delay. This significantly increased the speed of the wheels without compromising a quick and accurate twist response.</p>

<p><img src="https://algarv.github.io/Portfolio/assets/images/good_control.gif" alt="Good Control" /></p>

<p>The timer came with a trade off between the IMU measurement frequency and the maximum step frequency, but I found reading the IMU at approximately 10 Hz (a 100 ms delay between measurements) and polling the motors at 500 Hz (a 2 ms timer) was most successful in generating a fast enough reaction time while supporting a high motor stepping frequency.</p>

<p>With the wheels more reactive, noise in the IMU also became more apparent. I started with a rolling average filter, which worked well to smooth the signal and reduce spikes. The rolling average was effective at slower speeds, but with a much more reactive control loop, I wanted to explore more advanced methods of sensor fusion. A complementary filter allowed me to supplement the noisy accelerometer data with the steadier (but driftier) gyroscope data. This significantly reduced the steady state measurement spikes from up to +/- 40 degree spikes to negligible noise when the bot is stable.</p>

<p><img src="https://algarv.github.io/Portfolio/assets/images/complimentary_filter.gif" alt="Getting Smoother" /></p>

<p><img src="https://algarv.github.io/Portfolio/assets/images/final.gif" alt="Last Run" /></p>

<p>Ultimately, after carefully tuning the PD gains and tweaking timer frequencies, my ballbot could balance for about 2 seconds before tipping over and losing control. I believe my biggest limitation was the tradeoff between measurement frequency and stepping frequency, and would like to try timer-based interrupts in future iteration or even separating the controller into multiple cores that could run the motor stepping commands and read the IMU simultaneously.</p>

<p>https://github.com/algarv/Ball_Balancing_Robot/</p>

            </div>

            <!-- Rating -->
            

            <!-- Post Date -->
            <p>
            <small>
                <span class="post-date"><time class="post-date" datetime="2021-05-23">23 May 2021</time></span>           
                
                </small>
            </p>

            <!-- Post Categories -->
            <div class="after-post-cats">
                <ul class="tags mb-4">
                    
                    
                    <li>
                        <a class="smoothscroll" href="/categories#C">C</a>
                    </li>
                    
                    <li>
                        <a class="smoothscroll" href="/categories#Controls">Controls</a>
                    </li>
                    
                    <li>
                        <a class="smoothscroll" href="/categories#Mechatronics">Mechatronics</a>
                    </li>
                    
                    <li>
                        <a class="smoothscroll" href="/categories#Solidworks">Solidworks</a>
                    </li>
                    
                </ul>
            </div>
            <!-- End Categories -->

            <!-- Post Tags -->
            <div class="after-post-tags">
                <ul class="tags">
                    
                    
                </ul>
            </div>
            <!-- End Tags -->

            <!-- Prev/Next -->
            <div class="row PageNavigation d-flex justify-content-between font-weight-bold">
            
            <a class="prev d-block col-md-6" href="//a_robotics_minor/"> &laquo; Robotics minor</a>
            
            
            <a class="next d-block col-md-6 text-lg-right" href="//cocktail/">Cocktail Maker &raquo; </a>
            
            <div class="clearfix"></div>
            </div>
            <!-- End Categories -->

        </div>
        <!-- End Post -->

    </div>
</div>
<!-- End Article
================================================== -->

<!-- Review with LD-JSON, adapt it for your needs if you like, but make sure you test the generated HTML source code first: 
https://search.google.com/structured-data/testing-tool/u/0/
================================================== -->

</div>

<!-- Categories Jumbotron
================================================== -->
<div class="jumbotron fortags">
	<div class="d-md-flex h-100">
		<div class="col-md-4 transpdark align-self-center text-center h-100">
            <div class="d-md-flex align-items-center justify-content-center h-100">
                <h2 class="d-md-block align-self-center py-1 font-weight-light">Explore <span class="d-none d-md-inline">→</span></h2>
            </div>
		</div>
		<div class="col-md-8 p-5 align-self-center text-center">
            
            
                
                    <a class="mt-1 mb-1" href="/categories#Computer-Vision">Computer Vision (4)</a>
                
                    <a class="mt-1 mb-1" href="/categories#Pose-Estimation">Pose Estimation (1)</a>
                
                    <a class="mt-1 mb-1" href="/categories#MediaPipe">MediaPipe (1)</a>
                
                    <a class="mt-1 mb-1" href="/categories#Mechatronics">Mechatronics (3)</a>
                
                    <a class="mt-1 mb-1" href="/categories#Controls">Controls (3)</a>
                
                    <a class="mt-1 mb-1" href="/categories#Solidworks">Solidworks (3)</a>
                
                    <a class="mt-1 mb-1" href="/categories#C">C (3)</a>
                
                    <a class="mt-1 mb-1" href="/categories#ROS">ROS (1)</a>
                
                    <a class="mt-1 mb-1" href="/categories#MoveIt">MoveIt (1)</a>
                
                    <a class="mt-1 mb-1" href="/categories#Python">Python (5)</a>
                
                    <a class="mt-1 mb-1" href="/categories#Intel-Realsense">Intel Realsense (3)</a>
                
                    <a class="mt-1 mb-1" href="/categories#Franka-Emika-Panda-Arm">Franka Emika Panda Arm (1)</a>
                
                    <a class="mt-1 mb-1" href="/categories#Group-Project">Group Project (2)</a>
                
                    <a class="mt-1 mb-1" href="/categories#3D-Printing">3D Printing (1)</a>
                
                    <a class="mt-1 mb-1" href="/categories#OpenCV">OpenCV (2)</a>
                
                    <a class="mt-1 mb-1" href="/categories#PincherX-100">PincherX 100 (1)</a>
                
                    <a class="mt-1 mb-1" href="/categories#CoppeliaSim">CoppeliaSim (1)</a>
                
                    <a class="mt-1 mb-1" href="/categories#Dynamic-Systems">Dynamic Systems (1)</a>
                
                    <a class="mt-1 mb-1" href="/categories#Simulation">Simulation (1)</a>
                
                    <a class="mt-1 mb-1" href="/categories#Jupyter-Notebook">Jupyter Notebook (1)</a>
                
                    <a class="mt-1 mb-1" href="/categories#ROS2">ROS2 (1)</a>
                
                    <a class="mt-1 mb-1" href="/categories#Motion-Planning">Motion Planning (1)</a>
                
                    <a class="mt-1 mb-1" href="/categories#Moveit">Moveit (1)</a>
                
                    <a class="mt-1 mb-1" href="/categories#Emika-Franka-Robot-Arm">Emika Franka Robot Arm (1)</a>
                
                    <a class="mt-1 mb-1" href="/categories#Embedded-Systems">Embedded Systems (1)</a>
                
                    <a class="mt-1 mb-1" href="/categories#I2C">I2C (1)</a>
                
            
            
		</div>
	</div>
</div>

<!-- Begin Footer
================================================== -->
<footer class="footer">
    <div class="container">
        <div class="row">
            <div class="col-md-6 col-sm-6 text-center text-lg-left">
                Copyright © 2022 James Oubre 
            </div>
            <div class="col-md-6 col-sm-6 text-center text-lg-right">    
                <a target="_blank" href="https://www.wowthemes.net/mediumish-free-jekyll-template/">Mediumish Jekyll Theme</a> by WowThemes.net
            </div>
        </div>
    </div>
</footer>
<!-- End Footer
================================================== -->

</div> <!-- /.site-content -->

<!-- Scripts
================================================== -->

<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.6/umd/popper.min.js" integrity="sha384-wHAiFfRlMFy6i5SRaxvfOCifBUQy1xHdJ/yoi7FRNXMRBu5WHdZYu1hA6ZOblgut" crossorigin="anonymous"></script>

<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.2.1/js/bootstrap.min.js" integrity="sha384-B0UglyR+jN6CkvvICOB2joaf5I4l3gm9GU6Hc1og6Ls7i6U/mkkaduKaBhlAXv9k" crossorigin="anonymous"></script>

<script src="/assets/js/mediumish.js"></script>



<script src="/assets/js/ie10-viewport-bug-workaround.js"></script> 


<script id="dsq-count-scr" src="//.disqus.com/count.js"></script>


</body>
</html>
